<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MUSHRA Listening Test</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #f5f4f0;
  --surface:   #ffffff;
  --surface2:  #f0efe9;
  --border:    #e0ddd4;
  --text:      #1a1916;
  --muted:     #7a7770;
  --accent:    #2a52d4;
  --accent-bg: #eef1fc;
  --accent-dk: #1e3fa8;
  --bad:       #c94040;
  --poor:      #c97030;
  --fair:      #b09020;
  --good:      #3a9060;
  --excellent: #2a52d4;
  --radius:    10px;
  --shadow:    0 1px 3px rgba(0,0,0,.06), 0 4px 16px rgba(0,0,0,.05);
}

body {
  font-family: 'Sora', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* â”€â”€ Top bar â”€â”€ */
#topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 2rem;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  gap: 1rem;
}

#topbar-title {
  font-size: .82rem;
  font-weight: 600;
  color: var(--muted);
  letter-spacing: .04em;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#progress-wrap {
  display: flex;
  align-items: center;
  gap: .75rem;
  flex-shrink: 0;
}

#progress-label {
  font-size: .78rem;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  white-space: nowrap;
}

#progress-bar-outer {
  width: 160px;
  height: 5px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}

#progress-bar-inner {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width .4s cubic-bezier(.4,0,.2,1);
}

#vol-wrap {
  display: flex;
  align-items: center;
  gap: .5rem;
  flex-shrink: 0;
}

#vol-icon {
  font-size: .82rem;
  color: var(--muted);
  user-select: none;
}

#vol-slider {
  width: 80px;
  height: 4px;
  accent-color: var(--accent);
  cursor: pointer;
}

/* â”€â”€ Main layout â”€â”€ */
#main {
  flex: 1;
  display: flex;
  justify-content: center;
  padding: 2.5rem 1rem 4rem;
}

.page-card {
  background: var(--surface);
  border-radius: 16px;
  box-shadow: var(--shadow);
  width: 100%;
  max-width: 880px;
  padding: 2.5rem 3rem;
  animation: fadeUp .28s ease both;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ Page header â”€â”€ */
.page-type-badge {
  display: inline-block;
  font-size: .72rem;
  font-weight: 600;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--accent);
  background: var(--accent-bg);
  border: 1px solid #c5cfee;
  border-radius: 20px;
  padding: .22rem .75rem;
  margin-bottom: .9rem;
}

.page-title {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -.02em;
  margin-bottom: .6rem;
}

.page-content {
  color: var(--muted);
  font-size: .91rem;
  line-height: 1.65;
  margin-bottom: 1.75rem;
}

/* â”€â”€ Reference row â”€â”€ */
.ref-row {
  display: flex;
  align-items: center;
  gap: .75rem;
  margin-bottom: 1.25rem;
  padding: .75rem 1rem;
  background: var(--surface2);
  border-radius: var(--radius);
  border: 1.5px solid var(--border);
}

.ref-label {
  font-size: .78rem;
  font-weight: 600;
  color: var(--muted);
  letter-spacing: .04em;
  text-transform: uppercase;
  white-space: nowrap;
}

/* â”€â”€ Scale header â”€â”€ */
.scale-header {
  display: grid;
  grid-template-columns: 170px 1fr 56px;
  align-items: center;
  margin-bottom: .35rem;
  padding: 0 .2rem;
}

.scale-labels {
  display: flex;
  justify-content: space-between;
}

.scale-lbl {
  font-size: .67rem;
  color: var(--muted);
  text-align: center;
  flex: 1;
  line-height: 1.3;
}

/* â”€â”€ Sample rows â”€â”€ */
.samples-list {
  display: flex;
  flex-direction: column;
  gap: .4rem;
  margin-bottom: .5rem;
}

.sample-row {
  display: grid;
  grid-template-columns: 170px 1fr 56px;
  align-items: center;
  gap: .75rem;
  background: var(--surface2);
  border-radius: var(--radius);
  padding: .8rem 1rem;
  border: 1.5px solid transparent;
  transition: border-color .15s, background .15s;
}

.sample-row:hover { border-color: var(--border); }
.sample-row.playing { background: var(--accent-bg); border-color: #c5cfee; }

/* â”€â”€ Play buttons â”€â”€ */
.play-btn {
  display: inline-flex;
  align-items: center;
  gap: .4rem;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 7px;
  padding: .4rem .8rem;
  font-family: 'Sora', sans-serif;
  font-size: .8rem;
  font-weight: 600;
  cursor: pointer;
  color: var(--text);
  transition: all .15s;
  white-space: nowrap;
  width: 100%;
  justify-content: flex-start;
}

.play-btn:hover   { border-color: var(--accent); color: var(--accent); }
.play-btn.active  { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }
.play-btn.ref-active { border-color: var(--accent-dk); color: var(--accent-dk); background: #dde3f7; }

.play-icon { font-size: .72rem; }

.play-count {
  margin-left: auto;
  font-family: 'JetBrains Mono', monospace;
  font-size: .67rem;
  color: var(--muted);
  background: rgba(0,0,0,.06);
  border-radius: 10px;
  padding: .1rem .38rem;
  min-width: 22px;
  text-align: center;
}

/* â”€â”€ Sliders â”€â”€ */
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 3px;
  outline: none;
  cursor: pointer;
  background: var(--border);
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  border: 3px solid white;
  box-shadow: 0 0 0 1.5px var(--accent), 0 2px 6px rgba(42,82,212,.2);
  margin-top: -7px;
  transition: transform .1s;
}

input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }

input[type="range"]::-moz-range-thumb {
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--accent); border: 3px solid white;
  box-shadow: 0 0 0 1.5px var(--accent); cursor: pointer;
}

.score-display {
  font-family: 'JetBrains Mono', monospace;
  font-size: .9rem;
  font-weight: 500;
  color: var(--accent);
  text-align: right;
  min-width: 32px;
}

/* â”€â”€ Warning â”€â”€ */
.must-play-warn {
  font-size: .76rem;
  color: var(--bad);
  margin-top: .5rem;
  display: none;
  padding: .45rem .75rem;
  background: #fef2f2;
  border-radius: 6px;
  border: 1px solid #fecaca;
}
.must-play-warn.show { display: block; }

/* â”€â”€ Footer nav â”€â”€ */
.page-footer {
  display: flex;
  align-items: center;
  gap: .75rem;
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
  flex-wrap: wrap;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: .45rem;
  padding: .58rem 1.35rem;
  border-radius: 8px;
  font-family: 'Sora', sans-serif;
  font-size: .86rem;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
  border: none;
}

.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: var(--accent-dk); }
.btn-outline { background: white; color: var(--text); border: 1.5px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }

.status-pill {
  font-size: .76rem;
  font-weight: 600;
  padding: .28rem .75rem;
  border-radius: 20px;
  margin-left: auto;
}
.pill-incomplete { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
.pill-complete   { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }

/* â”€â”€ Generic page â”€â”€ */
.generic-icon {
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--accent-bg); border: 1px solid #c5cfee;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; margin-bottom: 1.25rem;
}

/* â”€â”€ Finish page â”€â”€ */
.finish-check {
  width: 72px; height: 72px; border-radius: 50%;
  background: #d1fae5; border: 1px solid #a7f3d0;
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 1.5rem;
}

.results-section { margin-top: 1.5rem; }

.results-group-title {
  font-size: .78rem;
  font-weight: 600;
  letter-spacing: .05em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: .5rem;
  margin-top: 1.25rem;
}

.results-table {
  width: 100%;
  border-collapse: collapse;
  font-size: .83rem;
}

.results-table th {
  text-align: left;
  padding: .45rem .7rem;
  background: var(--surface2);
  border-bottom: 1.5px solid var(--border);
  font-size: .72rem;
  letter-spacing: .04em;
  color: var(--muted);
  text-transform: uppercase;
}

.results-table td {
  padding: .5rem .7rem;
  border-bottom: 1px solid var(--border);
}

.results-table tr:last-child td { border-bottom: none; }

.bar-cell { width: 130px; }
.bar-bg { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; }

.hidden-ref-tag {
  font-size: .68rem; font-weight: 600;
  background: #fef3c7; color: #92400e;
  border: 1px solid #fde68a;
  border-radius: 10px; padding: .1rem .45rem;
}

/* â”€â”€ Save status / download â”€â”€ */
.save-status {
  display: inline-flex; align-items: center; gap: .4rem;
  font-size: .8rem; padding: .35rem .8rem; border-radius: 6px;
}
.save-ok      { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
.save-fail    { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
.save-pending { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

.action-row { display: flex; gap: .75rem; margin-top: 1.25rem; flex-wrap: wrap; align-items: center; }

.dl-btn {
  display: inline-flex; align-items: center; gap: .5rem;
  padding: .55rem 1.2rem; background: #1a1916; color: white;
  border: none; border-radius: 8px;
  font-family: 'Sora', sans-serif; font-size: .84rem; font-weight: 600;
  cursor: pointer; transition: background .15s;
}
.dl-btn:hover { background: #333; }

/* â”€â”€ Toast â”€â”€ */
#toast {
  position: fixed; bottom: 1.75rem; right: 1.75rem;
  background: #1a1916; color: white;
  padding: .65rem 1.2rem; border-radius: 10px;
  font-size: .82rem; font-weight: 500;
  box-shadow: 0 4px 20px rgba(0,0,0,.18);
  transform: translateY(8px); opacity: 0;
  transition: all .22s; pointer-events: none; z-index: 999;
}
#toast.show { transform: translateY(0); opacity: 1; }

/* â”€â”€ Responsive â”€â”€ */
@media (max-width: 600px) {
  .page-card { padding: 1.5rem 1.1rem; }
  .sample-row, .scale-header { grid-template-columns: 100px 1fr 44px; gap: .5rem; }
  #progress-bar-outer { width: 80px; }
}
</style>
</head>
<body>

<div id="topbar">
  <span id="topbar-title">Loadingâ€¦</span>
  <div id="vol-wrap">
    <span id="vol-icon">ğŸ”ˆ</span>
    <input id="vol-slider" type="range" min="0" max="1" step="0.01" value="1">
  </div>
  <div id="progress-wrap">
    <span id="progress-label">1 / 1</span>
    <div id="progress-bar-outer"><div id="progress-bar-inner" style="width:0%"></div></div>
  </div>
</div>

<div id="main"></div>
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â–¼â–¼â–¼  EDIT YOUR TEST CONFIG HERE  â–¼â–¼â–¼
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script id="cfg" type="application/json">
{
  "testname":             "Perceptual Effects of Acoustic Manipulation",
  "testId":               "uncanny_valley",
  "showButtonPreviousPage": true,
  "remoteService":        "https://script.google.com/macros/s/AKfycbyjRyYTy1foX8EH61lU46Sqs3BEcJ8hpLAPB90MmBlBgeJYPq3rEPxmKtPkd5grz7OD/exec",

  "pages": [
    {
      "type": "consent",
      "name": "Participant Information & Consent"
    },

    {
      "type":    "generic",
      "name":    "Introduction",
      "content": "Welcome. You will listen to a reference voice and several synthetic speech samples. Please rate each sample on the 0â€“100 scale provided. Listen to each sample as many times as you need before rating. <strong>You must play the reference and every sample at least once before moving on.</strong>"
    },

    {
      "type":      "mushra",
      "name":      "Human-likeness",
      "id":        "human_likeness",
      "content":   "Rate how <strong>human-like</strong> each voice sounds compared to the reference.",
      "randomize": true,
      "reference": { "label": "Reference", "src": "sensitive.wav" },
      "stimuli": [
        { "id": "S1",  "label": "Sample A",         "condition": "low",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S2",  "label": "Sample B",         "condition": "med",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S3",  "label": "Sample C",         "condition": "high",      "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "REF", "label": "Hidden Reference", "condition": "reference", "src": "sensitive.wav", "isHiddenRef": true  }
      ]
    },

    {
      "type":      "mushra",
      "name":      "Likability",
      "id":        "likability",
      "content":   "Rate how <strong>likable</strong> each voice sounds compared to the reference.",
      "randomize": true,
      "reference": { "label": "Reference", "src": "sensitive.wav" },
      "stimuli": [
        { "id": "S1",  "label": "Sample A",         "condition": "low",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S2",  "label": "Sample B",         "condition": "med",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S3",  "label": "Sample C",         "condition": "high",      "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "REF", "label": "Hidden Reference", "condition": "reference", "src": "sensitive.wav", "isHiddenRef": true  }
      ]
    },

    {
      "type":      "mushra",
      "name":      "Eeriness",
      "id":        "eeriness",
      "content":   "Rate how <strong>eerie</strong> each voice sounds compared to the reference.",
      "randomize": true,
      "reference": { "label": "Reference", "src": "sensitive.wav" },
      "stimuli": [
        { "id": "S1",  "label": "Sample A",         "condition": "low",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S2",  "label": "Sample B",         "condition": "med",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S3",  "label": "Sample C",         "condition": "high",      "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "REF", "label": "Hidden Reference", "condition": "reference", "src": "sensitive.wav", "isHiddenRef": true  }
      ]
    },

    {
      "type":      "mushra",
      "name":      "Emotional Naturalness",
      "id":        "emotional_naturalness",
      "content":   "Rate how <strong>emotionally natural</strong> each voice sounds compared to the reference.",
      "randomize": true,
      "reference": { "label": "Reference", "src": "sensitive.wav" },
      "stimuli": [
        { "id": "S1",  "label": "Sample A",         "condition": "low",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S2",  "label": "Sample B",         "condition": "med",       "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "S3",  "label": "Sample C",         "condition": "high",      "src": "sensitive.wav", "isHiddenRef": false },
        { "id": "REF", "label": "Hidden Reference", "condition": "reference", "src": "sensitive.wav", "isHiddenRef": true  }
      ]
    },

    {
      "type":        "finish",
      "name":        "Thank You",
      "content":     "Thank you for participating. Your responses have been recorded.",
      "showResults": false
    }
  ]
}
</script>
<!-- â–²â–²â–²  END CONFIG  â–²â–²â–² -->

<script>
'use strict';

/* â”€â”€ utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $   = id => document.getElementById(id);
const mk  = (tag, cls, html) => { const e = document.createElement(tag); if (cls) e.className = cls; if (html !== undefined) e.innerHTML = html; return e; };
const shuffle = a => { const b = [...a]; for (let i = b.length-1; i>0; i--) { const j = Math.floor(Math.random()*(i+1)); [b[i],b[j]]=[b[j],b[i]]; } return b; };
const uuid4 = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random()*16|0; return (c==='x'?r:(r&0x3|0x8)).toString(16); });

function toast(msg, ms=2800) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}

function scoreColor(v) {
  v = +v;
  if (v < 20) return 'var(--bad)';
  if (v < 40) return 'var(--poor)';
  if (v < 60) return 'var(--fair)';
  if (v < 80) return 'var(--good)';
  return 'var(--excellent)';
}

function paintSlider(slider) {
  const v = slider.value;
  const c = scoreColor(v);
  slider.style.background = `linear-gradient(to right,${c} 0%,${c} ${v}%,var(--border) ${v}%,var(--border) 100%)`;
}

/* â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CFG        = JSON.parse($('cfg').textContent);
const SESSION    = uuid4();
let   CUR_PAGE   = 0;
const RESULTS    = {};          // { pageId: { stimId: score } }
const PLAY_CNT   = {};          // { "pageIdx_stimId": n }
const PAGE_ORDER = {};          // { pageIdx: [stim,...] }  â€” randomised once per page
const PAGE_TIMES = {};          // { pageIdx: { elapsed, lastStart } }
let   CUR_AUDIO  = null;
let   CUR_BTN_ID = null;
let   CUR_ROW_ID = null;

/* â”€â”€ boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('topbar-title').textContent = CFG.testname;
$('vol-slider').addEventListener('input', () => {
  if (CUR_AUDIO) CUR_AUDIO.volume = +$('vol-slider').value;
});
go(0);

/* â”€â”€ navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function go(idx) {
  stopAudio();
  // Accumulate time spent on the page we're leaving
  if (PAGE_TIMES[CUR_PAGE]) {
    PAGE_TIMES[CUR_PAGE].elapsed += Date.now() - PAGE_TIMES[CUR_PAGE].lastStart;
  }
  CUR_PAGE = idx;
  // Start timing the new page
  if (!PAGE_TIMES[idx]) PAGE_TIMES[idx] = { elapsed: 0 };
  PAGE_TIMES[idx].lastStart = Date.now();
  const page  = CFG.pages[idx];
  const total = CFG.pages.length;

  $('progress-label').textContent     = `${idx+1} / ${total}`;
  $('progress-bar-inner').style.width = `${((idx+1)/total)*100}%`;

  const main = $('main');
  main.innerHTML = '';

  if      (page.type === 'consent') main.appendChild(buildConsent(page, idx));
  else if (page.type === 'generic') main.appendChild(buildGeneric(page, idx));
  else if (page.type === 'mushra')  main.appendChild(buildMushra(page, idx));
  else if (page.type === 'finish')  main.appendChild(buildFinish(page, idx));
}

/* â”€â”€ generic page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildGeneric(page, idx) {
  const card = mk('div','page-card');
  card.innerHTML = `
    <div class="generic-icon">ğŸ“‹</div>
    <span class="page-type-badge">Information</span>
    <h1 class="page-title">${page.name}</h1>
    <p class="page-content">${page.content}</p>`;
  card.appendChild(makeFooter(idx, () => true));
  return card;
}

/* â”€â”€ consent page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildConsent(page, idx) {
  const card = mk('div','page-card');
  card.innerHTML = `
    <div class="generic-icon">ğŸ“‹</div>
    <span class="page-type-badge">Participant Information</span>
    <h1 class="page-title">${page.name}</h1>
    <p class="page-content">This listening test is part of an academic research study on voice perception. Your participation helps us better understand how people evaluate synthesised speech. The session takes approximately 10â€“15 minutes.</p>
    <p class="page-content" style="margin-top:1rem;font-weight:600;color:var(--text)">By participating in this study, you confirm that:</p>
    <ul style="color:var(--muted);font-size:.91rem;line-height:1.65;margin:.75rem 0 1.5rem 1.5rem;display:flex;flex-direction:column;gap:.35rem">
      <li>Your participation is voluntary</li>
      <li>Your responses are anonymous</li>
      <li>The data will be used only for academic research purposes</li>
    </ul>
    <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer;font-size:.91rem;font-weight:600;color:var(--text)">
      <input type="checkbox" id="consent-check" style="width:18px;height:18px;accent-color:var(--accent);cursor:pointer;flex-shrink:0">
      I consent to participate in this study
    </label>`;
  card.appendChild(makeFooter(idx, () => {
    if (!$('consent-check').checked) {
      toast('âš  Please confirm your consent before continuing.');
      return false;
    }
    return true;
  }));
  return card;
}

/* â”€â”€ mushra page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildMushra(page, idx) {
  const card  = mk('div','page-card');
  const pageId = page.id;

  // build/retrieve randomised order (stable across back-navigation)
  if (!PAGE_ORDER[idx]) PAGE_ORDER[idx] = page.randomize ? shuffle(page.stimuli) : [...page.stimuli];
  const ordered = PAGE_ORDER[idx];

  if (!RESULTS[pageId]) RESULTS[pageId] = {};
  // default all to 50
  ordered.forEach(s => { if (RESULTS[pageId][s.id] === undefined) RESULTS[pageId][s.id] = 50; });

  const mIdx   = CFG.pages.slice(0, idx+1).filter(p => p.type==='mushra').length;
  const mTotal = CFG.pages.filter(p => p.type==='mushra').length;

  card.innerHTML = `
    <span class="page-type-badge">MUSHRA Â· ${mIdx} of ${mTotal}</span>
    <h1 class="page-title">${page.name}</h1>
    <p class="page-content">${page.content}</p>`;

  // reference row
  const refRow = mk('div','ref-row');
  refRow.id = `refrow-${idx}`;
  const refBtn = mk('button','play-btn');
  refBtn.id = `refbtn-${idx}`;
  refBtn.innerHTML = `<span class="play-icon">â–¶</span>${page.reference.label}
    <span class="play-count" id="pc-${idx}-REF">${cnt(idx,'REF')}Ã—</span>`;
  refBtn.onclick = () => playAudio(page.reference.src, refBtn.id, idx, 'REF', refRow.id);
  refRow.appendChild(refBtn);
  const refLabel = mk('span','ref-label','Reference Track');
  refRow.appendChild(refLabel);
  card.appendChild(refRow);

  // scale header
  const sh = mk('div','scale-header');
  sh.innerHTML = `<div></div>
    <div class="scale-labels">
      <span class="scale-lbl">Bad<br>0â€“20</span>
      <span class="scale-lbl">Poor<br>20â€“40</span>
      <span class="scale-lbl">Fair<br>40â€“60</span>
      <span class="scale-lbl">Good<br>60â€“80</span>
      <span class="scale-lbl">Excellent<br>80â€“100</span>
    </div><div></div>`;
  card.appendChild(sh);

  // sample rows
  const list = mk('div','samples-list');
  ordered.forEach((stim, i) => {
    const letter = String.fromCharCode(65 + i);
    const row    = mk('div','sample-row');
    row.id       = `row-${idx}-${stim.id}`;

    const btn = mk('button','play-btn');
    btn.id = `playbtn-${idx}-${stim.id}`;
    btn.innerHTML = `<span class="play-icon">â–¶</span>Sample ${letter}
      <span class="play-count" id="pc-${idx}-${stim.id}">${cnt(idx,stim.id)}Ã—</span>`;
    btn.onclick = () => playAudio(stim.src, btn.id, idx, stim.id, row.id);

    const slider = mk('input');
    slider.type  = 'range'; slider.min = 0; slider.max = 100;
    slider.value = RESULTS[pageId][stim.id];
    slider.id    = `sl-${idx}-${stim.id}`;
    slider.oninput = () => {
      scoreEl.textContent = slider.value;
      paintSlider(slider);
      RESULTS[pageId][stim.id] = +slider.value;
      refreshPill(idx);
    };
    paintSlider(slider);

    const scoreEl = mk('div','score-display', RESULTS[pageId][stim.id]);

    row.appendChild(btn);
    row.appendChild(slider);
    row.appendChild(scoreEl);
    list.appendChild(row);
  });
  card.appendChild(list);

  // warning
  const warn = mk('p','must-play-warn','âš  Please play the reference and all samples at least once before continuing.');
  warn.id = `warn-${idx}`;
  card.appendChild(warn);

  card.appendChild(makeFooter(idx, () => {
    if (!allPlayed(idx)) { $(`warn-${idx}`).classList.add('show'); toast('âš  Play every sample before continuing.'); return false; }
    $(`warn-${idx}`).classList.remove('show'); return true;
  }));

  return card;
}

function cnt(pageIdx, stimId) { return PLAY_CNT[`${pageIdx}_${stimId}`] || 0; }

function incCnt(pageIdx, stimId) {
  const key = `${pageIdx}_${stimId}`;
  PLAY_CNT[key] = (PLAY_CNT[key]||0) + 1;
  const el = $(`pc-${pageIdx}-${stimId}`);
  if (el) el.textContent = PLAY_CNT[key] + 'Ã—';
}

function allPlayed(idx) {
  const p = CFG.pages[idx];
  if (!p || p.type !== 'mushra') return true;
  if (!cnt(idx,'REF')) return false;
  return p.stimuli.every(s => cnt(idx, s.id) > 0);
}

function refreshPill(idx) {
  const pill = $(`pill-${idx}`);
  if (!pill) return;
  const ok = allPlayed(idx);
  pill.textContent = ok ? 'Ready âœ“' : 'Not rated';
  pill.className   = 'status-pill ' + (ok ? 'pill-complete' : 'pill-incomplete');
}

/* â”€â”€ finish page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildFinish(page, idx) {
  const card = mk('div','page-card');
  card.innerHTML = `
    <div class="finish-check">âœ“</div>
    <span class="page-type-badge">Complete</span>
    <h1 class="page-title" style="text-align:center">${page.name}</h1>
    <p class="page-content" style="text-align:center">${page.content}</p>`;

  if (page.showResults !== false) {
    const sec = mk('div','results-section');
    CFG.pages.filter(p => p.type==='mushra').forEach(mp => {
      const mpIdx = CFG.pages.indexOf(mp);
      const order = PAGE_ORDER[mpIdx] || mp.stimuli;

      const title = mk('div','results-group-title', mp.name);
      sec.appendChild(title);

      const table = mk('table','results-table');
      table.innerHTML = `<thead><tr>
        <th>Sample</th><th>Score</th><th class="bar-cell">Distribution</th><th>Played</th><th>Note</th>
      </tr></thead>`;
      const tbody = mk('tbody');
      order.forEach((stim, i) => {
        const score = RESULTS[mp.id]?.[stim.id] ?? 'â€“';
        const color = typeof score==='number' ? scoreColor(score) : 'var(--border)';
        const tr = mk('tr');
        tr.innerHTML = `
          <td>Sample ${String.fromCharCode(65+i)}</td>
          <td><strong>${score}</strong></td>
          <td class="bar-cell"><div class="bar-bg"><div class="bar-fill" style="width:${score}%;background:${color}"></div></div></td>
          <td style="font-family:'JetBrains Mono',monospace;font-size:.78rem">${cnt(mpIdx,stim.id)}Ã—</td>
          <td>${stim.isHiddenRef ? '<span class="hidden-ref-tag">Hidden Ref</span>' : ''}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      sec.appendChild(table);
    });
    card.appendChild(sec);
  }

  // save status
  const statusWrap = mk('div',''); statusWrap.id='save-status'; statusWrap.style.marginTop='1.5rem';
  card.appendChild(statusWrap);

  // action row
  const actions = mk('div','action-row');
  const dl = mk('button','dl-btn','â¬‡ Download CSV'); dl.onclick = downloadCSV;
  actions.appendChild(dl);
  if (CFG.showButtonPreviousPage && idx > 0) {
    const prev = mk('button','btn btn-outline','â† Previous'); prev.onclick=()=>go(idx-1);
    actions.appendChild(prev);
  }
  card.appendChild(actions);

  // auto-post
  saveToServer(statusWrap);
  return card;
}

/* â”€â”€ footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function makeFooter(idx, validateFn) {
  const footer = mk('div','page-footer');
  const total  = CFG.pages.length;
  const page   = CFG.pages[idx];

  if (CFG.showButtonPreviousPage && idx > 0) {
    const prev = mk('button','btn btn-outline','â† Previous');
    prev.onclick = () => go(idx - 1);
    footer.appendChild(prev);
  }

  if (idx < total - 1) {
    const next = mk('button','btn btn-primary','Continue â†’');
    next.onclick = () => { if (validateFn && !validateFn()) return; go(idx+1); };
    footer.appendChild(next);
  }

  if (page.type === 'mushra') {
    const pill = mk('span','status-pill pill-incomplete','Not rated');
    pill.id = `pill-${idx}`;
    footer.appendChild(pill);
  }

  return footer;
}

/* â”€â”€ audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function clearActiveUI() {
  document.querySelectorAll('.play-btn.active,.play-btn.ref-active').forEach(b => {
    b.classList.remove('active','ref-active');
    const ic = b.querySelector('.play-icon'); if (ic) ic.textContent='â–¶';
  });
  document.querySelectorAll('.sample-row.playing,.ref-row.playing').forEach(r => r.classList.remove('playing'));
}

function stopAudio() {
  if (CUR_AUDIO) { CUR_AUDIO.pause(); CUR_AUDIO.currentTime=0; CUR_AUDIO=null; }
  clearActiveUI();
  CUR_BTN_ID = null;
  CUR_ROW_ID = null;
}

function setPlayingUI(btnId, rowId, stimId) {
  const btn = $(btnId);
  const row = $(rowId);
  const isRef = stimId === 'REF';
  if (btn) { btn.classList.add(isRef ? 'ref-active' : 'active'); const ic=btn.querySelector('.play-icon'); if(ic) ic.textContent='â¸'; }
  if (row) row.classList.add('playing');
}

function setPausedUI(btnId, rowId) {
  const btn = $(btnId);
  const row = $(rowId);
  if (btn) { btn.classList.remove('active','ref-active'); btn.classList.add('paused'); const ic=btn.querySelector('.play-icon'); if(ic) ic.textContent='â–¶'; }
  if (row) row.classList.remove('playing');
}

function playAudio(src, btnId, pageIdx, stimId, rowId) {
  const btn = $(btnId);

  // --- Case 1: clicking the currently active (playing) button â†’ PAUSE ---
  if (CUR_AUDIO && !CUR_AUDIO.paused && CUR_BTN_ID === btnId) {
    CUR_AUDIO.pause();
    setPausedUI(btnId, rowId);
    return;
  }

  // --- Case 2: clicking the currently paused button â†’ RESUME ---
  if (CUR_AUDIO && CUR_AUDIO.paused && CUR_BTN_ID === btnId) {
    CUR_AUDIO.play().catch(() => toast('âš  Could not resume â€” check audio path.'));
    setPlayingUI(btnId, rowId, stimId);
    return;
  }

  // --- Case 3: clicking a different button â†’ stop current, start new ---
  stopAudio();

  if (!src) { toast('âš  No audio configured for this sample.'); return; }

  const audio = new Audio(src);
  audio.volume = +$('vol-slider').value;
  CUR_AUDIO   = audio;
  CUR_BTN_ID  = btnId;
  CUR_ROW_ID  = rowId;

  setPlayingUI(btnId, rowId, stimId);

  incCnt(pageIdx, stimId);
  refreshPill(pageIdx);

  audio.play().catch(() => { toast('âš  Could not play â€” check audio path.'); stopAudio(); });

  audio.onended = () => {
    clearActiveUI();
    CUR_AUDIO  = null;
    CUR_BTN_ID = null;
    CUR_ROW_ID = null;
  };
}

/* â”€â”€ results payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildPayload() {
  const headers = ['session_test_id','session_uuid','trial_id','rating_stimulus','rating_condition','rating_score','rating_time','rating_comment'];
  const dataRows = [];
  CFG.pages.filter(p => p.type === 'mushra').forEach(p => {
    const mpIdx   = CFG.pages.indexOf(p);
    const order   = PAGE_ORDER[mpIdx] || p.stimuli;
    const elapsed = PAGE_TIMES[mpIdx] ? PAGE_TIMES[mpIdx].elapsed : 0;
    order.forEach(s => {
      dataRows.push([
        CFG.testId,
        SESSION,
        p.id,
        s.id,
        s.condition || '',
        RESULTS[p.id] && RESULTS[p.id][s.id] !== undefined ? RESULTS[p.id][s.id] : '',
        elapsed,
        ''
      ]);
    });
  });
  return {
    sheet:     'Results',
    rows:      [headers, ...dataRows],
    testId:    CFG.testId,
    sessionId: SESSION
  };
}

/* â”€â”€ server save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveToServer(statusEl) {
  if (!CFG.remoteService) {
    statusEl.innerHTML = `<span class="save-status save-pending">No server configured â€” use CSV download.</span>`;
    return;
  }
  statusEl.innerHTML = `<span class="save-status save-pending">â³ Submitting to Google Sheetsâ€¦</span>`;
  fetch(CFG.remoteService, {
    method: 'POST',
    body: JSON.stringify(buildPayload())
  }).then(r => r.text())
  .then(() => {
    statusEl.innerHTML = `<span class="save-status save-ok">âœ“ Submitted to Google Sheets</span>`;
  }).catch(e => {
    statusEl.innerHTML = `<span class="save-status save-fail">âœ— Submission failed (${e.message}) â€” please download CSV.</span>`;
  });
}

/* â”€â”€ CSV download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function downloadCSV() {
  const p   = buildPayload();
  const csv = p.rows.map(r => r.map(v => `"${String(v ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download=`${p.testId}_${p.sessionId}.csv`; a.click();
  URL.revokeObjectURL(url);
  toast('âœ“ CSV downloaded');
}
</script>
</body>
</html>
